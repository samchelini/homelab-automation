---
- name: create .kube directory
  hosts: localhost
  tasks:
  - ansible.builtin.file:
      path: /home/ansible/.kube
      state: directory

- name: get kubeconfig
  hosts: ops_k8s
  tasks:
  - ansible.builtin.fetch:
      src: /etc/kubernetes/admin.conf
      dest: /home/ansible/.kube/config
      flat: true
    when: inventory_hostname in groups["ops_k8s"] and inventory_hostname in groups["kube_control_plane"]
    run_once: true
    become: true

- name: configure cluster
  hosts: localhost
  tasks:
  - name: get kube-proxy configmap
    kubernetes.core.k8s_info:
      api_version: v1
      kind: ConfigMap
      namespace: kube-system
      name: kube-proxy
    register: kube_proxy_config

  - name: enable strictARP on kube-proxy for metallb
    kubernetes.core.k8s:
      state: patched
      kind: ConfigMap
      api_version: v1
      namespace: kube-system
      name: kube-proxy
      definition:
        data:
          config.conf: '{{ kube_proxy_config.resources[0].data["config.conf"] | replace("strictARP: false", "strictARP: true")}}'

  - name: install metallb
    kubernetes.core.helm:
      release_name: metallb
      release_namespace: metallb-system
      chart_ref: metallb
      chart_repo_url: https://metallb.github.io/metallb
      create_namespace: true
      wait: true

  - name: apply metallb address pool
    kubernetes.core.k8s:
      definition:
        apiVersion: metallb.io/v1beta1
        kind: IPAddressPool
        metadata:
          name: default
          namespace: metallb-system
        spec:
          addresses:
          - '{{ ingress_nginx_address }}'
          autoAssign: true
      apply: yes
    vars:
      ingress_nginx_address: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                30336632356533336339333136363463373933316239656563383336326535353562313436653030
                3333333066636666636631303863303263666338396437390a303864663935336461343865336663
                61363463353563626362396463353733666566356132646265353261393035353233613131386362
                3364336463373461390a616332623930353963313930323566343962646662333366353662313463
                3366

  - name: apply metallb l2 advertisement
    kubernetes.core.k8s:
      definition:
        apiVersion: metallb.io/v1beta1
        kind: L2Advertisement
        metadata:
          name: default
          namespace: metallb-system
        spec:
          ipAddressPools:
          - default
      apply: yes

  - name: install ingress-nginx
    kubernetes.core.helm:
      release_namespace: ingress-nginx
      release_name: ingress-nginx
      chart_ref: ingress-nginx
      chart_repo_url: https://kubernetes.github.io/ingress-nginx
      create_namespace: true
      wait: true
      values:
        controller:
          service:
            type: LoadBalancer

  - name: install cert-manager
    kubernetes.core.helm:
      release_name: cert-manager
      release_namespace: cert-manager
      chart_ref: "oci://quay.io/jetstack/charts/cert-manager"
      create_namespace: true
      wait: true
      set_values:
        - value: crds.enabled=true

  - name: install porkbun-webhook
    block:
      - name: porkbun-webhook | get latest release url
        ansible.builtin.uri:
          url: https://api.github.com/repos/mdonoughe/porkbun-webhook/releases/latest
        register: porkbun_webhook_release

      - name: porkbun-webhook | install
        kubernetes.core.helm:
          release_name: porkbun-webhook
          release_namespace: cert-manager
          chart_ref: '{{ porkbun_webhook_release.json.assets | community.general.json_query(qry) }}'
          wait: true
          set_values:
            - value: groupName="porkbun-webhook"
        vars:
          qry: "[?starts_with(name, 'porkbun-webhook') && ends_with(name, '.tgz')].browser_download_url | [0]"

      - name: porkbun-webhook | create secret
        kubernetes.core.k8s:
          state: present
          definition:
            apiVersion: v1
            kind: Secret
            type: Opaque
            metadata:
              name: porkbun-key
              namespace: cert-manager
            data:
              api-key: '{{ porkbun_api_key | b64encode }}'
              secret-key: '{{ porkbun_secret_key | b64encode }}'
        vars:
          porkbun_api_key: !vault |
                    $ANSIBLE_VAULT;1.1;AES256
                    34663864376130336331393366383237656237393535623962313464396363623330643337393264
                    3937656434383262343661386236383062373733613334350a646133646136363765346263646333
                    33666235333566633163643437353239633738653632636430623633626362393533343439643831
                    3461373434366263310a306265356135313137393765636566356435323164653138353566376335
                    30323732373766343335663838326434386536383561663031343435326133323065623638326566
                    65613437316234326461323032346536396566656430303465373038343936646366646638306363
                    37316134653435393930376538626134353037326666326535336534343765623764373835376134
                    64386462363733623162
          porkbun_secret_key: !vault |
                    $ANSIBLE_VAULT;1.1;AES256
                    64653932376532313162396666613332303362623831376330346465383034333537383232613862
                    3335323538623836343833393863346137383364633631330a663561363433626464383739343332
                    66616566353833633231653963643732613734633731323732323036376165316565646436393163
                    3166346235316364370a303966386162646262356338363536383666343136333235613162633639
                    39386165326533663536663437626434626430393937353465356339336566626462303865386230
                    61353963323061346234366339343765396637613834363633383866616339646637356437313931
                    37346538363033313339333333396137363031356438663363613561313564366234636434653764
                    33663735353361393064

      - name: porkbun-webhook | create role
        kubernetes.core.k8s:
          namespace: cert-manager
          definition:
            apiVersion: rbac.authorization.k8s.io/v1
            kind: Role
            metadata:
              name: porkbun-key:reader
            rules:
              - apiGroups: [""]
                resources: ["secrets"]
                resourceNames: ["porkbun-key"]
                verbs: ["get"]

      - name: porkbun-webhook | create rolebinding
        kubernetes.core.k8s:
          namespace: cert-manager
          definition:
            apiVersion: rbac.authorization.k8s.io/v1
            kind: RoleBinding
            metadata:
              name: porkbun-webhook:key-reader
            roleRef:
              apiGroup: rbac.authorization.k8s.io
              kind: Role
              name: porkbun-key:reader
            subjects:
              - apiGroup: ""
                kind: ServiceAccount
                name: porkbun-webhook

      - name: porkbun-webhook | create cluster issuer
        kubernetes.core.k8s:
          definition:
            apiVersion: cert-manager.io/v1
            kind: ClusterIssuer
            metadata:
              name: letsencrypt
            spec:
              acme:
                server: https://acme-v02.api.letsencrypt.org/directory
                email: '{{ my_email }}'
                privateKeySecretRef:
                  name: letsencrypt-key
                solvers:
                  - selector:
                      dnsZones:
                        - k8s.{{ ops_domain }}
                    dns01:
                      webhook:
                        groupName: porkbun-webhook
                        solverName: porkbun
                        config:
                          apiKeySecretRef:
                            name: porkbun-key
                            key: api-key
                          secretKeySecretRef:
                            name: porkbun-key
                            key: secret-key

  - name: apply ops-k8s-storageclass storageclass
    kubernetes.core.k8s:
      definition:
        kind: StorageClass
        apiVersion: storage.k8s.io/v1
        metadata:
          name: ops-k8s-storageclass
          annotations:
            storageclass.kubernetes.io/is-default-class: "true"
        provisioner: csi.vsphere.vmware.com
        parameters:
          storagepolicyname: "ops-k8s-storageclass"
          fstype: ext4
      apply: yes

  - name: install authentik
    block:
      - name: authentik | install helm chart
        kubernetes.core.helm:
          release_name: authentik
          release_namespace: authentik
          chart_ref: authentik
          chart_repo_url: https://charts.goauthentik.io
          create_namespace: true
          wait: true
          set_values:
            - value: authentik.bootstrap_password='{{ authentik_bootstrap_password }}'
            - value: authentik.bootstrap_token='{{ authentik_bootstrap_password }}'
            - value: authentik.secret_key='{{ authentik_secret_key }}'
            - value: authentik.error_reporting.enabled=false
            - value: authentik.postgresql.password='{{ authentik_postgresql_password }}'
            - value: server.ingress.ingressClassName="nginx"
            - value: server.ingress.enabled=true
            - value: server.ingress.hosts=["authentik.k8s.{{ ops_domain }}"]
              value_type: json
            - value: 'server.ingress.annotations={"nginx.ingress.kubernetes.io/force-ssl-redirect": "true", "cert-manager.io/cluster-issuer": "letsencrypt"}'
              value_type: json
            - value: postgresql.enabled=true
            - value: postgresql.auth.password='{{ authentik_postgresql_password }}'
            - value: redis.enabled=true
            - value: 'server.ingress.tls=[{"hosts": ["authentik.k8s.{{ ops_domain }}"], "secretName": "authentik-tls"}]'
              value_type: json
        register: authentik_install

      - name: authentik | wait for install
        ansible.builtin.pause:
          seconds: 30
        when: authentik_install is changed

      - name: authentik | get ops group
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/core/groups/?name=ops
          method: GET
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          status_code: 200
          body_format: json
        register: get_ops_group

      - name: authentik | create ops group
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/core/groups/
          method: POST
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          body:
            name: ops
            is_superuser: true
          status_code: 201
          body_format: json
        when: get_ops_group.json.pagination.count != 1
        register: created_ops_group

      - name: authentik | set ops_group var
        ansible.builtin.set_fact:
          ops_group_guid: '{{ get_ops_group.json.results[0].pk | default(created_ops_group.json.pk) }}'

      - name: authentik | get sysadmin user
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/core/users/?name=sysadmin
          method: GET
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          status_code: 200
          body_format: json
        register: get_sysadmin_user

      - name: authentik | create sysadmin user
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/core/users/
          method: POST
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          body:
            username: sysadmin
            name: sysadmin
            email: sysadmin@{{ lab_domain }}
            is_active: true
            groups:
              - '{{ ops_group_guid }}'
            type: internal
          status_code: 201
          body_format: json
        when: get_sysadmin_user.json.pagination.count != 1
        register: created_sysadmin_user

      - name: authentik | set sysadmin user password
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/core/users/{{ created_sysadmin_user.json.pk }}/set_password/
          method: POST
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          body:
            password: '{{ sysadmin_password }}'
          status_code: 204
          body_format: json
        when: created_sysadmin_user.json is defined

      - name: authentik | get authorization flow
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/flows/instances/?slug=default-provider-authorization-explicit-consent
          method: GET
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          status_code: 200
          body_format: json
        register: authorization_flow

      - name: authentik | get invalidation flow
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/flows/instances/?slug=default-provider-invalidation-flow
          method: GET
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          status_code: 200
          body_format: json
        register: invalidation_flow

      - name: authentik | get oidc certificate
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/crypto/certificatekeypairs/?name=oidc-cert
          method: GET
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          status_code: 200
          body_format: json
        register: get_oidc_certificate

      - name: authentik | create oidc certificate
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/crypto/certificatekeypairs/generate/
          method: POST
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          body:
            common_name: oidc-cert
            validity_days: 365
            alg: rsa
          status_code: 200
          body_format: json
        when: get_oidc_certificate.json.pagination.count != 1
        register: created_oidc_certificate

      - name: authentik | set oidc_certificate var
        ansible.builtin.set_fact:
          oidc_certificate: '{{ get_oidc_certificate.json.results[0].pk | default(created_oidc_certificate.json.pk) }}'

      - name: authentik | get openid scope
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/propertymappings/all/?managed=goauthentik.io/providers/oauth2/scope-openid
          method: GET
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          status_code: 200
          body_format: json
        register: openid_scope

      - name: authentik | get email scope
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/propertymappings/all/?managed=goauthentik.io/providers/oauth2/scope-email
          method: GET
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          status_code: 200
          body_format: json
        register: email_scope

      - name: authentik | get email scope
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/propertymappings/all/?managed=goauthentik.io/providers/oauth2/scope-profile
          method: GET
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          status_code: 200
          body_format: json
        register: profile_scope

      - name: authentik | get concourse provider
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/providers/oauth2/?name=concourse-oauth
          method: GET
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          status_code: 200
          body_format: json
        register: get_concourse_provider

      - name: authentik | create concourse provider
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/providers/oauth2/
          method: POST
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          body:
            name: concourse-oauth
            authorization_flow: '{{ authorization_flow.json.results[0].pk }}'
            invalidation_flow: '{{ invalidation_flow.json.results[0].pk }}'
            signing_key: '{{ oidc_certificate }}'
            property_mappings:
              - '{{ openid_scope.json.results[0].pk }}'
              - '{{ email_scope.json.results[0].pk }}'
              - '{{ profile_scope.json.results[0].pk }}'
            redirect_uris:
              - matching_mode: strict
                url: "https://concourse.k8s.{{ ops_domain }}/sky/issuer/callback"
            client_type: confidential
            client_id: "{{ lookup('ansible.builtin.password', '/dev/null', chars=['ascii_letters', 'digits'], length=64) }}"
            client_secret: "{{ lookup('ansible.builtin.password', '/dev/null', chars=['ascii_letters', 'digits'], length=64) }}"
          status_code: 201
          body_format: json
        when: get_concourse_provider.json.pagination.count != 1
        register: created_concourse_provider

      - name: authentik | set concourse_provider
        ansible.builtin.set_fact:
          concourse_provider: '{{ get_concourse_provider.json.results[0] | default(created_concourse_provider.json) }}'

      - name: authentik | get concourse application
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/core/applications/?name=Concourse
          method: GET
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          status_code: 200
          body_format: json
        register: get_concourse_application

      - name: authentik | create concourse application
        ansible.builtin.uri:
          url: https://authentik.k8s.{{ ops_domain }}/api/v3/core/applications/
          method: POST
          headers:
            Authorization: Bearer {{ authentik_bootstrap_password }}
          unredirected_headers:
            - Authorization
          body:
            name: Concourse
            slug: concourse
            provider: '{{ concourse_provider.pk }}'
          status_code: 201
          body_format: json
        when: get_concourse_application.json.pagination.count != 1
        register: created_concourse_application
    vars:
      authentik_secret_key: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                30333836653561393564376633613630356232633035333539326337303365643830376238393737
                3035326233656133393362376235616137633938323831380a363563653364386261323438353636
                39363434343835633731313534363839383461363166363136336163653365346162636238303162
                3263383337393637310a376430363638633738393434646234663235343536636535656636336262
                65623464653239336138393235656336373766366562653561653835396538663336666130326633
                66323232313838396132623165373930323333306463393938393761333665613366623165383063
                61616431356139633065313035356664326161343535613565363337613261393231316533366364
                66646435616438383565373338353734303562346431336631616537633564616430313364366365
                6565
      authentik_postgresql_password: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                30663364346361663333663961626235343330656631353436346434656334356630353662353939
                6335613635616430656638333964353937316634613065610a636432343364343363303833386634
                39386564333736633563346663313334376236623031383163616136636139613339316434663937
                6136333636373338620a363933316562633934663632393532613433653063346163303733333738
                65343238383666613232356334643664623839643862663336343566643938646265303035326630
                33353232393064303938363031323665656436393937303734356537366365353063356465383336
                32663330313737333665393164653762636163363531313663653932323339356234326637353131
                39356565343138393437633137613764376138313064306662626266316237316632333639383466
                3332
      authentik_bootstrap_password: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                31353031333466343464373233313435306464313239303239633631346637383664356231393832
                6233666466393861376533396231656235386234663632310a343833316461356536663965313564
                62373064656235666136376134636638363465396262316534343139396630643433626362633064
                3838316166346334340a346633343936646561376638353334353233333664363434663138626430
                66383963316236313034363463373430323935353866323136356236323162626562
      sysadmin_password: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                66653239636230386335393230336135633734613733663931636462393338326166613932353966
                3366386533333733623161323738333864393366396233320a353334363533613435353934353438
                63353632316462633338363834323235653330613363323236643866336333633332623539643664
                3766346535613966380a306266363666656161383638666266326465346231353139393233616233
                64636661393732376136363536313466633135303935366235333364333966643038

  - name: install concourse
    kubernetes.core.helm:
      release_name: concourse
      release_namespace: concourse
      chart_ref: concourse
      chart_repo_url: https://concourse-charts.storage.googleapis.com
      create_namespace: true
      wait: true
      set_values:
        - value: 'concourse.web.externalUrl=https://concourse.k8s.{{ ops_domain }}'
        - value: 'concourse.web.auth.mainTeam.oidc.group=ops'
        - value: 'concourse.web.auth.localAuth.enabled=false'
        - value: 'concourse.web.auth.oidc.enabled=true'
        - value: 'concourse.web.auth.oidc.displayName=Authentik'
        - value: 'concourse.web.auth.oidc.issuer=https://authentik.k8s.{{ ops_domain }}/application/o/concourse/'
        - value: 'concourse.web.auth.oidc.userNameKey=name'
        - value: 'secrets.oidcClientId={{ concourse_provider.client_id }}'
        - value: 'secrets.oidcClientSecret={{ concourse_provider.client_secret }}'
        - value: web.ingress.enabled=true
        - value: web.ingress.ingressClassName="nginx"
        - value: 'web.ingress.annotations={"nginx.ingress.kubernetes.io/force-ssl-redirect": "true", "cert-manager.io/cluster-issuer": "letsencrypt"}'
          value_type: json
        - value: web.ingress.hosts=["concourse.k8s.{{ ops_domain }}"]
          value_type: json
        - value: 'web.ingress.tls=[{"hosts": ["concourse.k8s.{{ ops_domain }}"], "secretName": "concourse-tls"}]'
          value_type: json
        - value: postgresql.customPgData="/opt/postgresql/data"
        - value: postgresql.dataVolumeMountPath="/opt/postgresql"
