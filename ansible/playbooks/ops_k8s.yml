---
- name: create vms
  hosts: localhost
  gather_facts: false
  tasks:
  - name: create vms
    include_role:
      name: create_vm
    with_items:
      - vm_name: ops-k8s-control-1
        vm_cpu_num: 4
        vm_memory_mb: 4096
        vm_cidr: !vault |
                  $ANSIBLE_VAULT;1.1;AES256
                  36356338646162616661643036303834373135376232656562336332323637663063363631306632
                  3533653763323733626361346365356666333234643732640a373661373565653434663963326466
                  62323138646237646133643835306534626637313634643036653733323732303637396138356363
                  6562616230393738350a626334636633393539313234666162306633653664323566303430333466
                  6162
      - vm_name: ops-k8s-control-2
        vm_cpu_num: 4
        vm_memory_mb: 4096
        vm_cidr: !vault |
                  $ANSIBLE_VAULT;1.1;AES256
                  33323132336337383863633534303761373235653931306265363161623234333966313834633135
                  6162633131643633653037333164376233636163343034630a343366643163666562363032653566
                  66333731643430326165366364306339346336613935633039306130346435316237653238396332
                  3865396135613030380a636361306637653566373164303131653138336562613233353839383238
                  3263
      - vm_name: ops-k8s-control-3
        vm_cpu_num: 4
        vm_memory_mb: 4096
        vm_cidr: !vault |
                  $ANSIBLE_VAULT;1.1;AES256
                  62613430613832393035363130336133646466383037373263343863336638393338633365313363
                  3261383638363835633733363664666136666164303164370a343732326266393537306238333864
                  65356232323863373230666138623836633836643236326232366265666466376630343137343231
                  3037383932306436380a656566336365613737383363623136313461346138616332323336316138
                  3365
      - vm_name: ops-k8s-worker-1
        vm_cpu_num: 4
        vm_memory_mb: 4096
        vm_cidr: !vault |
                  $ANSIBLE_VAULT;1.1;AES256
                  66333333396532393638303562643431353262613664643361323663393162303234386539306238
                  6138653535643861613563663064306234376564326132660a313038386366393263313838613138
                  65306539346236343661643865336135656230616362326261613934636462633030333163636164
                  6434346663313930300a666230663236666433383238666633343561613633626532623161353532
                  6637
      - vm_name: ops-k8s-worker-2
        vm_cpu_num: 4
        vm_memory_mb: 4096
        vm_cidr: !vault |
                  $ANSIBLE_VAULT;1.1;AES256
                  34633435623762616566363063353963653036353035633935333338343665663966663261333530
                  6236303138643331323837633362323265323032376433620a316134376538386635363630633735
                  34653538666434613262303763356137376138653565333035616333366364323430376337616463
                  3333373532343761380a383862623032323636306364353436383165353334393535303335373831
                  6363
      - vm_name: ops-k8s-worker-3
        vm_cpu_num: 4
        vm_memory_mb: 4096
        vm_cidr: !vault |
                  $ANSIBLE_VAULT;1.1;AES256
                  34383064626536373462633231636336646662326539333265313861646665323534613138316665
                  3033323330323239646263623830623864636131663563310a363233306433613262313235386566
                  34646135656237316139313733303164383333346534313732386439646538613764356432386365
                  3366626566623336300a376564666437323466643039343264313234643635633733643034613261
                  6162
    vars:
      vm_name: "{{ item.vm_name }}"
      vm_cpu_num: "{{ item.vm_cpu_num }}"
      vm_memory_mb: "{{ item.vm_memory_mb }}"
      vm_disk_gb: 50
      vcenter_resource_pool: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                66353732663932653832653633343938353563373734353463343634316431616131613138373565
                6230343832326263313935393631326638323537313764390a633233323239303933653335623565
                32383137653866626232633266396133643939336661646339616130653439393063366634353963
                3431336461663332620a633362326361366531663033343030633234613232333532656264306366
                6230
      vm_network: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                63633131623565363436643838303132613234623139666166623132306535396536613937356137
                3035623336363661313033626235643164383737663563610a386263383465306466326430623061
                39643564363265363031346632616465363034363066363062613239363735643830616539363131
                6533613566643135660a346637353537663035366561383639303838663061666634366465343065
                65373031363766313838396630636565346463386533356530356465636436653264
      vm_cidr: "{{ item.vm_cidr }}"
      vm_gateway: !vault |
                  $ANSIBLE_VAULT;1.1;AES256
                  30663464373738323132313139356662393838646566356562393963323861306332646461656635
                  6163613665346262386464393038326563393439646536610a393563636533336639303661333332
                  61623837616236376161643232356630376133396336393339363337323362623931346131336435
                  3561366438393932360a313138353533346237376661373163356562363036653539333738333964
                  3037
      disk_enable_uuid: "TRUE"

- hosts: ops_k8s
  roles:
    - extend-lvm
  tasks:
  - name: install required packages
    ansible.builtin.package:
      name:
        - python3-kubernetes

- name: install kubernetes
  ansible.builtin.import_playbook: kubernetes_sigs.kubespray.cluster
  vars:
    cloud_provider: "external"
    external_cloud_provider: "vsphere"
    external_vsphere_vcenter_ip: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              62623339623630316239613264633636656563343063363763383066313566353535396466343532
              6165383865323064643561363166326133346337353566310a316238636463393934623963313662
              65666266613331356665303838363135303333616664636661323931353535316365656630323739
              3132313265366432610a663238373864353761643238653564613062323962613262326536393333
              35366562346562346365613464336665623734633463346531393837346430643062
    external_vsphere_user: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              34393638313333633465346636643361633264626234353863356332653464333833383235626562
              3530646331326437363836313331666164343363356162360a626433366461383864646363333364
              65396138343535663335333666613061653664613538643938363732393830316335623031303564
              3936656433353661320a343339653965663339336632373237623364353333383839303965623764
              64393439643936663830303766393938353361356232643138333062666266663735
    external_vsphere_password: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              31393739336539393165643831383439393966633765656631613136633465613639393231346237
              3139656462393634666466366263616334306237653861330a623534316566363937376439326366
              32323965306639313437643337643134323232666337383632323638363564616234316664623031
              3738623835633834310a383133643035623332613866613734333831303865383764373663373665
              37393439643161653361353030623166643765393163653134336162623266366630
    external_vsphere_datacenter: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              33313830633466666537613661306138616465656363306165636437346237333337393962616661
              3530363335636463383761643161653932666261393965300a613139343864346634306562643737
              30656365336163366137623433333261306130626433383239313439666134386465356333313933
              3432643237626162630a373262373835366232333433643461623930353639303363346337666532
              3562
    external_vsphere_kubernetes_cluster_id: ops-k8s
    vsphere_csi_enabled: true
    vsphere_csi_namespace: vmware-system-csi
  when: inventory_hostname in groups["ops_k8s"]

- name: create .kube directory
  hosts: localhost
  tasks:
  - ansible.builtin.file:
      path: /home/ansible/.kube
      state: directory
    become: false

- name: get kubeconfig
  hosts: ops_k8s
  tasks:
  - ansible.builtin.fetch:
      src: /etc/kubernetes/super-admin.conf
      dest: /home/ansible/.kube/config
      flat: true
    when: inventory_hostname in groups["ops_k8s"] and inventory_hostname in groups["kube_control_plane"]
    run_once: true

- name: configure cluster
  hosts: localhost
  tasks:
  - name: get kube-proxy configmap
    kubernetes.core.k8s_info:
      api_version: v1
      kind: ConfigMap
      namespace: kube-system
      name: kube-proxy
    register: kube_proxy_config

  - name: enable strictARP on kube-proxy for metallb
    kubernetes.core.k8s:
      state: patched
      kind: ConfigMap
      api_version: v1
      namespace: kube-system
      name: kube-proxy
      definition:
        data:
          config.conf: '{{ kube_proxy_config.resources[0].data["config.conf"] | replace("strictARP: false", "strictARP: true")}}'

  - name: install metallb
    kubernetes.core.helm:
      release_name: metallb
      release_namespace: metallb-system
      chart_ref: metallb
      chart_repo_url: https://metallb.github.io/metallb
      create_namespace: true
      wait: true

  - name: apply metallb address pool
    kubernetes.core.k8s:
      definition:
        apiVersion: metallb.io/v1beta1
        kind: IPAddressPool
        metadata:
          name: default
          namespace: metallb-system
        spec:
          addresses:
          - '{{ ingress_nginx_address }}'
          autoAssign: true
      apply: yes

  - name: apply metallb l2 advertisement
    kubernetes.core.k8s:
      definition:
        apiVersion: metallb.io/v1beta1
        kind: L2Advertisement
        metadata:
          name: default
          namespace: metallb-system
        spec:
          ipAddressPools:
          - default
      apply: yes

  - name: install ingress-nginx
    kubernetes.core.helm:
      release_namespace: ingress-nginx
      release_name: ingress-nginx
      chart_ref: ingress-nginx
      chart_repo_url: https://kubernetes.github.io/ingress-nginx
      create_namespace: true
      wait: true
      values:
        controller:
          service:
            type: LoadBalancer

  - name: apply ops-k8s-storageclass storageclass
    kubernetes.core.k8s:
      definition:
        kind: StorageClass
        apiVersion: storage.k8s.io/v1
        metadata:
          name: ops-k8s-storageclass
          annotations:
            storageclass.kubernetes.io/is-default-class: "true"
        provisioner: csi.vsphere.vmware.com
        parameters:
          storagepolicyname: "ops-k8s-storageclass"
          fstype: ext4
      apply: yes
